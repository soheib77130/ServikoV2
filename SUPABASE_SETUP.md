# Configuration Supabase — Serviko

Ce guide prépare une authentification fonctionnelle pour **clients** et **indépendants**.

## 1) Variables déjà configurées
Les pages HTML utilisent :
- `SUPABASE_URL = https://skfqoyyoahuaffshimnc.supabase.co`
- `SUPABASE_ANON_KEY = sb_publishable_yxLCOU94zhGck9yvGYch5Q_ePCPd9Yq`

## 2) Créer les tables
Exécutez le SQL ci-dessous dans l'éditeur SQL Supabase.

```sql
create table if not exists public.clients (
  id bigint generated by default as identity primary key,
  user_id uuid not null unique,
  firstname text,
  lastname text,
  email text,
  company text,
  created_at timestamptz default now()
);

create table if not exists public.independants (
  id bigint generated by default as identity primary key,
  user_id uuid not null unique,
  firstname text,
  lastname text,
  email text,
  phone text,
  city text,
  status text,
  portfolio text,
  siret text,
  daily_rate numeric,
  experience text,
  skills text,
  created_at timestamptz default now()
);

create table if not exists public.requests (
  id bigint generated by default as identity primary key,
  client_user_id uuid not null,
  assigned_indep_user_id uuid,
  title text not null,
  category text,
  budget numeric,
  negotiated_price numeric,
  deadline text,
  style text,
  skills text,
  description text,
  questionnaire jsonb,
  spec_checklist jsonb,
  match_score numeric,
  match_summary text,
  status text default 'nouveau',
  created_at timestamptz default now()
);

create table if not exists public.request_matches (
  id bigint generated by default as identity primary key,
  request_id bigint not null references public.requests (id) on delete cascade,
  indep_user_id uuid not null,
  score numeric not null,
  rank int not null,
  created_at timestamptz default now()
);

create table if not exists public.request_messages (
  id bigint generated by default as identity primary key,
  request_id bigint not null references public.requests (id) on delete cascade,
  sender_user_id uuid not null,
  sender_role text not null,
  channel text default 'instant',
  body text not null,
  created_at timestamptz default now()
);
```

## 3) Activer le RLS + Policies
```sql
alter table public.clients enable row level security;
alter table public.independants enable row level security;
alter table public.requests enable row level security;
alter table public.request_matches enable row level security;
alter table public.request_messages enable row level security;

create policy "clients_insert_own" on public.clients
  for insert with check (auth.uid() = user_id);

create policy "clients_select_own" on public.clients
  for select using (auth.uid() = user_id);

create policy "clients_update_own" on public.clients
  for update using (auth.uid() = user_id)
  with check (auth.uid() = user_id);

create policy "indep_insert_own" on public.independants
  for insert with check (auth.uid() = user_id);

create policy "indep_select_own" on public.independants
  for select using (auth.uid() = user_id);

create policy "indep_update_own" on public.independants
  for update using (auth.uid() = user_id)
  with check (auth.uid() = user_id);

create policy "requests_insert_own" on public.requests
  for insert with check (auth.uid() = client_user_id);

create policy "requests_select_client" on public.requests
  for select using (auth.uid() = client_user_id);

create policy "requests_select_indep" on public.requests
  for select using (auth.uid() = assigned_indep_user_id);

create policy "requests_update_client" on public.requests
  for update using (auth.uid() = client_user_id)
  with check (auth.uid() = client_user_id);

create policy "requests_update_indep" on public.requests
  for update using (auth.uid() = assigned_indep_user_id)
  with check (auth.uid() = assigned_indep_user_id);

-- Permettre aux indépendants de voir les demandes non assignées
create policy "requests_select_open_for_indep" on public.requests
  for select using (
    assigned_indep_user_id is null
    and auth.uid() in (select user_id from public.independants)
  );

-- Permettre aux indépendants de réclamer une demande non assignée
create policy "requests_claim_open_for_indep" on public.requests
  for update using (
    assigned_indep_user_id is null
    and auth.uid() in (select user_id from public.independants)
  )
  with check (auth.uid() = assigned_indep_user_id);

create policy "request_matches_select_client" on public.request_matches
  for select using (
    auth.uid() = (select client_user_id from public.requests where id = request_id)
  );

create policy "request_matches_insert_client" on public.request_matches
  for insert with check (
    auth.uid() = (select client_user_id from public.requests where id = request_id)
  );

create policy "request_messages_select_participants" on public.request_messages
  for select using (
    auth.uid() = (select client_user_id from public.requests where id = request_id)
    or auth.uid() = (select assigned_indep_user_id from public.requests where id = request_id)
  );

create policy "request_messages_insert_participants" on public.request_messages
  for insert with check (
    sender_user_id = auth.uid()
    and (
      auth.uid() = (select client_user_id from public.requests where id = request_id)
      or auth.uid() = (select assigned_indep_user_id from public.requests where id = request_id)
    )
  );
```

## 4) Config Auth (obligatoire)
- **Auth → URL Configuration**
  - Site URL: `http://localhost:8000`
  - Redirect URLs: `http://localhost:8000/*`
  - Redirect email confirm: `http://localhost:8000/confirmed.html`

## 5) Démarrage local
```bash
python -m http.server 8000
```
Puis ouvrez :
- `http://localhost:8000/signup.html`
- `http://localhost:8000/indep-signup.html`

## 6) Vérifications rapides
- Une inscription crée un utilisateur Supabase Auth.
- Une ligne est insérée dans `clients` ou `independants`.
- Les dashboards récupèrent les données via `auth.uid()`.
